<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Pivot App â€“ Responsive + Touch</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<!-- jQuery + jQuery UI -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>

<!-- Touch support for jQuery UI drag/drop -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui-touch-punch/0.2.3/jquery.ui.touch-punch.min.js"></script>

<!-- PivotTable.js -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pivottable/2.23.0/pivot.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/pivottable/2.23.0/pivot.min.js"></script>

<!-- Parsers -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.20.2/xlsx.full.min.js"></script>

<style>
:root { --bg:#0f172a; --card:#111827; --ink:#e5e7eb; --muted:#9ca3af; --accent:#22c55e; }
*{box-sizing:border-box}
body{margin:0;font:14px/1.35 system-ui,Segoe UI,Roboto,Arial;color:var(--ink);background:var(--bg)}
header{display:flex;align-items:center;gap:12px;padding:14px 16px;border-bottom:1px solid #1f2937;flex-wrap:wrap}
h1{margin:0;font-size:16px;font-weight:700}
.toolbar{display:flex;gap:8px;flex-wrap:wrap;margin-left:auto}
.btn{background:#1f2937;color:var(--ink);border:1px solid #374151;padding:8px 12px;border-radius:10px;cursor:pointer}
.btn:hover{border-color:#4b5563}
.btn.primary{background:var(--accent);border-color:var(--accent);color:#05220e;font-weight:700}
.chip{padding:4px 8px;background:#0b1220;border:1px dashed #334155;border-radius:8px;color:var(--muted)}
main{display:grid;grid-template-columns:280px 1fr;gap:14px;padding:14px}
aside,.panel{background:var(--card);border:1px solid #1f2937;border-radius:12px;padding:12px}
#output{background:#0b1220;border:1px solid #1f2937;border-radius:12px;padding:8px;min-height:520px;overflow:auto}
.pvtUi{color:#111 !important} /* keep pivot UI readable */
.footer{color:var(--muted);font-size:12px;padding:8px 14px 16px}
input[type="file"]{display:none}

/* --- Mobile responsiveness --- */
@media (max-width: 900px){
  main{grid-template-columns:1fr}
  aside{order:-1}
  #output{min-height:420px}
  .toolbar{width:100%;margin-left:0}
}
@media (max-width: 600px){
  header{gap:8px}
  .btn{padding:8px 10px;border-radius:8px}
  .pvtAxisContainer,.pvtVals{min-height:44px} /* larger drop zones */
  /* allow horizontal nav inside pivot UI on mobile */
  #output{overflow:auto}
}

/* Mobile Simple Builder panel (shown on touch or small width) */
#mobileBuilder{display:none;gap:10px;flex-wrap:wrap;margin:10px 0}
#mobileBuilder select{background:#0b1220;color:var(--ink);border:1px solid #334155;border-radius:8px;padding:8px;min-width:150px}
#mobileBuilder .stack{display:flex;flex-direction:column;gap:6px;min-width:160px}
#mobileToggle{display:none;margin-left:0}
@media (max-width: 900px){
  #mobileToggle{display:inline-block}
}
</style>
</head>
<body>

<header>
  <h1>Pivot Table (Responsive + Touch)</h1>
  <span class="chip" id="datasetName">No dataset loaded</span>

  <button class="btn" id="mobileToggle">ðŸ“± Mobile Builder</button>

  <div class="toolbar">
    <label class="btn" for="fileInput">ðŸ“„ Upload CSV/XLSX</label>
    <input id="fileInput" type="file" accept=".csv,.xlsx,.xls" />
    <button class="btn" id="loadSample">Load Sample</button>
    <button class="btn" id="saveView">Save View</button>
    <button class="btn" id="loadView">Load View</button>
    <button class="btn" id="resetView">Reset</button>
    <button class="btn primary" id="exportCsv">Export Pivot CSV</button>
  </div>
</header>

<main>
  <aside>
    <h3 style="margin:0 0 8px">How it works</h3>
    <ol class="hint">
      <li>Upload CSV/XLSX or load sample.</li>
      <li><b>Desktop:</b> drag fields into Rows/Cols/Values/Filters.</li>
      <li><b>Mobile:</b> tap <b>Mobile Builder</b> to select fields (no drag required).</li>
      <li>Export the current pivot as CSV.</li>
    </ol>
    <p class="hint">Date columns autoâ€‘create <b>Year</b> & <b>Month</b> derived fields.</p>
  </aside>

  <section class="panel">
    <!-- Mobile Simple Builder (appears on small screens or when toggled) -->
    <div id="mobileBuilder">
      <div class="stack">
        <label>Rows</label>
        <select id="rowsSel" multiple size="4"></select>
      </div>
      <div class="stack">
        <label>Columns</label>
        <select id="colsSel" multiple size="4"></select>
      </div>
      <div class="stack">
        <label>Values</label>
        <select id="valsSel" multiple size="4"></select>
      </div>
      <div class="stack">
        <label>Filters</label>
        <select id="filtersSel" multiple size="4"></select>
      </div>
      <div class="stack" style="justify-content:flex-end">
        <label>&nbsp;</label>
        <button class="btn primary" id="applyMobile">Apply</button>
      </div>
    </div>

    <div id="output"></div>
  </section>
</main>

<div class="footer">Openâ€‘source stack: PivotTable.js, jQuery UI (+Touchâ€‘Punch), Papa Parse, SheetJS.</div>

<script>
const $out = $("#output");
let currentData = [];
let currentName = "No dataset loaded";
let derivedAttrs = {};
let lastOpts = null;

// --- touch / mobile detection ---
const isTouch = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
if (isTouch || window.innerWidth < 900) { $("#mobileToggle").show(); }

$("#mobileToggle").on("click", () => {
  $("#mobileBuilder").slideToggle(120);
});

function isLikelyDate(v){
  if (v instanceof Date) return true;
  if (typeof v !== "string") return false;
  return /\d{4}-\d{1,2}-\d{1,2}/.test(v) || /\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4}/.test(v);
}
function toDate(v){ if (v instanceof Date) return v; const d=new Date(v); return isNaN(d)?null:d; }

function buildDerivedAttributes(data){
  const derived = {};
  if (!data.length) return derived;
  const keys = Object.keys(data[0]||{});
  for (const col of keys){
    let hits=0,tr=0;
    for (let i=0;i<Math.min(30,data.length);i++){
      const v=data[i][col]; if (v==null || v==="") continue; tr++; if (isLikelyDate(v)) hits++;
    }
    if (tr>0 && hits/tr>=0.5){
      derived[`${col} (Year)`] = r => { const d=toDate(r[col]); return d?d.getFullYear():""; };
      derived[`${col} (Month)`] = r => { const d=toDate(r[col]); return d?(d.getMonth()+1+"").padStart(2,"0"):""; };
    }
  }
  return derived;
}

function fillMobileSelectors(fields){
  const $r=$("#rowsSel"),$c=$("#colsSel"),$v=$("#valsSel"),$f=$("#filtersSel");
  const opts = fields.map(f=>`<option value="${f}">${f}</option>`).join("");
  $r.html(opts); $c.html(opts); $v.html(opts); $f.html(opts);
}

function getMobileConfig(){
  const rows=[...$("#rowsSel")[0].selectedOptions].map(o=>o.value);
  const cols=[...$("#colsSel")[0].selectedOptions].map(o=>o.value);
  const vals=[...$("#valsSel")[0].selectedOptions].map(o=>o.value);
  const filters=[...$("#filtersSel")[0].selectedOptions].map(o=>o.value);
  return {rows,cols,vals,filters};
}

function renderPivot(data,name="Dataset", seed){
  currentData = data; currentName = name;
  $("#datasetName").text(name);
  derivedAttrs = buildDerivedAttributes(data);

  const utils = $.pivotUtilities;
  const renderers = utils.renderers;
  const aggregators = utils.aggregators;

  // prepare mobile selects
  const baseFields = Object.keys(data[0]||{});
  const derivedFields = Object.keys(derivedAttrs);
  fillMobileSelectors([...baseFields, ...derivedFields]);

  // default / or seed from saved config
  const opts = Object.assign({
    renderers,
    aggregators,
    aggregatorName: "Count",
    rendererName: "Table",
    derivedAttributes: derivedAttrs,
    rows: [], cols: []
  }, seed || {});

  $out.empty().pivotUI(data, opts, true);
  lastOpts = opts;
}

function reRenderWithMobile(){
  if (!currentData.length) return;
  const conf = getMobileConfig();
  const base = {
    renderers: $.pivotUtilities.renderers,
    aggregators: $.pivotUtilities.aggregators,
    rendererName: "Table",
    aggregatorName: "Count",
    derivedAttributes: derivedAttrs,
    rows: conf.rows, cols: conf.cols, vals: conf.vals
  };
  $out.empty().pivotUI(currentData, base, true);
}

function exportCurrentPivotAsCSV(){
  const tbl = document.querySelector("#output .pvtTable");
  if (!tbl){ alert("No pivot table rendered yet."); return; }
  const rows=[];
  for (const tr of tbl.querySelectorAll("tr")){
    const cells=[];
    for (const td of tr.children){
      let t=(td.innerText||"").replace(/\n/g," ").trim();
      if (t.includes(",")||t.includes("\"")) t=`"${t.replace(/"/g,'""')}"`;
      cells.push(t);
    }
    rows.push(cells.join(","));
  }
  const blob=new Blob([rows.join("\n")],{type:"text/csv;charset=utf-8"});
  const url=URL.createObjectURL(blob); const a=document.createElement("a");
  a.href=url; a.download=(currentName.replace(/\.[a-z0-9]+$/i,"")||"pivot")+"_pivot.csv";
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}

function saveView(){
  const ui = $("#output");
  const opts = ui.data("pivotUIOptions");
  if (!opts){ alert("No pivot view to save."); return; }
  const keep = (({ rows, cols, vals, rendererName, aggregatorName, derivedAttributes }) =>
    ({ rows, cols, vals, rendererName, aggregatorName, derivedAttributes }))(opts);
  localStorage.setItem("pivot-saved-view", JSON.stringify(keep));
  alert("View saved.");
}
function loadView(){
  const raw = localStorage.getItem("pivot-saved-view");
  if (!raw){ alert("No saved view."); return; }
  const conf = JSON.parse(raw);
  if (!currentData.length){ alert("Load a dataset first."); return; }
  renderPivot(currentData, currentName, conf);
  // also reflect in mobile selects
  $("#rowsSel option, #colsSel option, #valsSel option, #filtersSel option").prop("selected", false);
  (conf.rows||[]).forEach(v=>$("#rowsSel option[value='"+v.replaceAll("'","\\'")+"']").prop("selected",true));
  (conf.cols||[]).forEach(v=>$("#colsSel option[value='"+v.replaceAll("'","\\'")+"']").prop("selected",true));
  (conf.vals||[]).forEach(v=>$("#valsSel option[value='"+v.replaceAll("'","\\'")+"']").prop("selected",true));
}

$("#applyMobile").on("click", reRenderWithMobile);

/* ---------- file handling ---------- */
$("#fileInput").on("change", (e)=>{
  const file=e.target.files?.[0]; if (!file) return;
  const name=file.name;
  if (/\.(xlsx|xls)$/i.test(name)){
    const r=new FileReader();
    r.onload=ev=>{
      const data=new Uint8Array(ev.target.result);
      const wb=XLSX.read(data,{type:"array",cellDates:true,cellNF:false,cellText:false});
      const ws=wb.Sheets[wb.SheetNames[0]];
      const json=XLSX.utils.sheet_to_json(ws,{defval:null});
      renderPivot(json,name);
    };
    r.readAsArrayBuffer(file);
  } else if (/\.csv$/i.test(name)){
    Papa.parse(file,{header:true,dynamicTyping:true,skipEmptyLines:true,
      complete:(res)=>renderPivot(res.data,name),
      error:(err)=>alert("CSV parse error: "+err.message)
    });
  } else { alert("Please upload .csv/.xlsx"); }
});

$("#exportCsv").on("click", exportCurrentPivotAsCSV);
$("#saveView").on("click", saveView);
$("#loadView").on("click", loadView);
$("#resetView").on("click", ()=>{ if (!currentData.length) return; renderPivot(currentData, currentName, lastOpts); });

$("#loadSample").on("click", ()=>{
  const sample=[
    { City:"Visakhapatnam", Hub:"VIZ-NAD-T2", LOB:"bbnow", Orders:12, Revenue:5900, Date:"2025-07-01" },
    { City:"Visakhapatnam", Hub:"VIZ-NAD-T2", LOB:"bbnow", Orders:17, Revenue:7200, Date:"2025-07-02" },
    { City:"Hyderabad", Hub:"HYD-Madhapur", LOB:"bbnow", Orders:22, Revenue:9100, Date:"2025-07-01" },
    { City:"Hyderabad", Hub:"HYD-Madhapur", LOB:"bbdaily", Orders:15, Revenue:4300, Date:"2025-07-03" },
    { City:"Vizianagaram", Hub:"VIZ-Gurudwara-T2", LOB:"bbnow", Orders:11, Revenue:3100, Date:"2025-07-02" }
  ];
  renderPivot(sample,"sample.csv");
});

// initial hint
$out.html('<div style="padding:14px;color:#cbd5e1">Upload a CSV/XLSX or tap <b>Load Sample</b>. Use <b>Mobile Builder</b> on phones.</div>');
</script>
</body>
</html>
